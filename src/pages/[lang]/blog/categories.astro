---
import BaseHead from '../../../components/BaseHead.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import FloatingLanguagePicker from '../../../components/FloatingLanguagePicker.astro';
import { getCollection } from 'astro:content';
import { useTranslations } from '../../../i18n/ui';

export function getStaticPaths() {
    const langs = ['ko', 'jp', 'en'];
    return langs.map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params;
const t = useTranslations(lang as 'ko' | 'jp' | 'en');

const allPosts = await getCollection('blog');
const posts = allPosts.filter((post) => post.id.startsWith(`${lang}/`));

const categoryMap = new Map<string, number>();

posts.forEach((post) => {
    const category = post.data.category ?? 'uncategorized';
    categoryMap.set(category, (categoryMap.get(category) ?? 0) + 1);
});

// ğŸ¨ í™•ì¥ëœ íŒŒìŠ¤í…” íŒ”ë ˆíŠ¸
const PALETTE = [
    'text-blue-400', 'text-green-400', 'text-purple-400', 'text-orange-400',
    'text-pink-400', 'text-yellow-400', 'text-teal-400', 'text-indigo-400',
    'text-red-400', 'text-cyan-400', 'text-lime-400', 'text-fuchsia-400',
    'text-rose-400', 'text-emerald-400', 'text-violet-400', 'text-sky-400',
    'text-amber-400',
    // Soft Pastels
    'text-red-300', 'text-orange-300', 'text-amber-300', 'text-yellow-300',
    'text-lime-300', 'text-green-300', 'text-emerald-300', 'text-teal-300',
    'text-cyan-300', 'text-sky-300', 'text-blue-300', 'text-indigo-300',
    'text-violet-300', 'text-purple-300', 'text-fuchsia-300', 'text-pink-300',
    'text-rose-300', 'text-slate-300',
    // Very Light Pastels
    'text-indigo-200', 'text-rose-200', 'text-teal-200', 'text-sky-200',
    // Custom Hex (Tailwind JITê°€ ìë™ìœ¼ë¡œ í´ë˜ìŠ¤ ìƒì„±)
    'text-[#ffadad]', 'text-[#ffd6a5]', 'text-[#fdffb6]', 'text-[#caffbf]',
    'text-[#9bf6ff]', 'text-[#a0c4ff]', 'text-[#bdb2ff]', 'text-[#ffc6ff]',
    'text-[#fffffc]'
];

const categories = Array.from(categoryMap.entries())
    .map(([key, count]) => {
        // ê²°ì •ë¡ ì  ìƒ‰ìƒ í• ë‹¹ (Deterministic Color Assignment)
        // ì¹´í…Œê³ ë¦¬ ì´ë¦„ì˜ ë¬¸ì ì½”ë“œë¥¼ ë‹¤ ë”í•´ì„œ í•´ì‹œë¥¼ ë§Œë“­ë‹ˆë‹¤.
        // ê²°ê³¼: "Devlog"ëŠ” ì–¸ì œ ì ‘ì†í•´ë„ í•­ìƒ ê°™ì€ ìƒ‰ìƒì´ ë‚˜ì˜µë‹ˆë‹¤.
        let hash = 0;
        for (let i = 0; i < key.length; i++) {
            hash = key.charCodeAt(i) + ((hash << 5) - hash);
        }
        const colorIndex = Math.abs(hash) % PALETTE.length;
        
        return {
            key,
            count,
            colorClass: PALETTE[colorIndex]
        };
    })
    .sort((a, b) => a.key.localeCompare(b.key, lang === 'jp' ? 'ja' : lang === 'ko' ? 'ko' : 'en'));
---

<!doctype html>
<html lang={lang}>
    <head>
        <BaseHead title={t('blog.categories-title')} description={t('blog.categories-description')} />
    </head>
    <body class="bg-[#0d1117] text-slate-300">
        <Header />
        <FloatingLanguagePicker />
        
        <main class="max-w-5xl mx-auto px-4 py-10">
            {/* ë§¥ë¶ ìœˆë„ìš° ì»¨í…Œì´ë„ˆ */}
            <div class="rounded-xl border border-slate-700 bg-[#161b22] shadow-2xl overflow-hidden min-h-[600px] flex flex-col">
                
                {/* 1. ìœˆë„ìš° í—¤ë” */}
                <div class="h-12 sm:h-10 bg-[#21262d] border-b border-slate-700 flex items-center px-3 sm:px-4 justify-between shrink-0">
                    <div class="flex gap-2">
                        <div class="w-3 h-3 rounded-full bg-[#ff5f56] border border-[#e0443e]"></div>
                        <div class="w-3 h-3 rounded-full bg-[#ffbd2e] border border-[#dea123]"></div>
                        <div class="w-3 h-3 rounded-full bg-[#27c93f] border border-[#1aab29]"></div>
                    </div>
                    <div class="text-xs sm:text-sm font-semibold text-slate-200 flex items-center gap-1">
                        hun-bot / categories
                    </div>
                    <div class="w-8 sm:w-14"></div>
                </div>

                {/* 2. ìœˆë„ìš° ë°”ë”” */}
                <div class="p-8">
                    <h1 class="text-2xl font-bold text-white mb-2">{t('blog.categories-title')}</h1>
                    <p class="text-slate-400 mb-8 text-sm">{t('blog.categories-description')}</p>

                    {categories.length === 0 ? (
                        <div class="flex flex-col items-center justify-center h-64 text-slate-500">
                            <span class="text-4xl mb-2">ğŸ“­</span>
                            <p>{t('blog.no-categories')}</p>
                        </div>
                    ) : (
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
                            {categories.map((category) => (
                                <a href={`/${lang}/blog/categories/${encodeURIComponent(category.key)}/`} class="group flex flex-col items-center p-4 rounded-lg hover:bg-[#2d333b] transition-colors duration-200">
                                    
                                    {/* í´ë” ì•„ì´ì½˜ (ì„œë²„ì—ì„œ ê³„ì‚°ëœ ìƒ‰ìƒ ì ìš©) */}
                                    <div class={`w-20 h-20 mb-3 ${category.colorClass} transition-transform duration-300 group-hover:scale-110 drop-shadow-md`}>
                                        <svg viewBox="0 0 24 24" fill="currentColor" class="w-full h-full">
                                            <path d="M19.5 21a3 3 0 0 0 3-3v-4.5a3 3 0 0 0-3-3h-15a3 3 0 0 0-3 3V18a3 3 0 0 0 3 3h15ZM1.5 10.146V6a3 3 0 0 1 3-3h5.379a2.25 2.25 0 0 1 1.59.659l2.122 2.121c.14.141.331.22.53.22H19.5a3 3 0 0 1 3 3v1.146A4.483 4.483 0 0 0 19.5 9h-15a4.483 4.483 0 0 0-3 1.146Z" />
                                        </svg>
                                    </div>
                                    
                                    <div class="text-center w-full">
                                        <span class="block text-sm font-medium text-slate-100 group-hover:text-white truncate w-full px-2" title={category.key}>
                                            {category.key}
                                        </span>
                                        <span class="text-xs text-slate-500 mt-1 block">
                                            {category.count} items
                                        </span>
                                    </div>
                                </a>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        </main>
        <Footer />
    </body>
</html>