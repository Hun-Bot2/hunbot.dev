---
import BaseHead from '../../../components/BaseHead.astro';
import Header from '../../../components/Header.astro';
import Footer from '../../../components/Footer.astro';
import FloatingLanguagePicker from '../../../components/FloatingLanguagePicker.astro';
import { getCollection } from 'astro:content';
import { useTranslations } from '../../../i18n/ui';

export function getStaticPaths() {
	const langs = ['ko', 'jp', 'en'];
	return langs.map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params;
const t = useTranslations(lang as 'ko' | 'jp' | 'en');

const allPosts = await getCollection('blog');
const posts = allPosts.filter((post) => post.id.startsWith(`${lang}/`));

const tagMap = new Map<string, number>();

posts.forEach((post) => {
	(post.data.tags ?? []).forEach((tag) => {
		tagMap.set(tag, (tagMap.get(tag) ?? 0) + 1);
	});
});

const tags = Array.from(tagMap.entries()).map(([name, count]) => ({ name, count })).sort((a, b) =>
	a.name.localeCompare(b.name, lang === 'jp' ? 'ja' : lang === 'ko' ? 'ko' : 'en')
);
---

<!doctype html>
<html lang={lang}>
	<head>
		<BaseHead title={t('blog.tags-title')} description={t('blog.tags-description')} />
	</head>
	<body>
		<Header />
		<FloatingLanguagePicker />
		<main class="max-w-4xl mx-auto px-6 py-10">
			<section>
				<h1 class="text-3xl font-bold text-slate-100 mb-6">{t('blog.tags-title')}</h1>
				<p class="text-slate-400 mb-10">{t('blog.tags-description')}</p>

				{tags.length === 0 ? (
					<p class="text-slate-400">{t('blog.no-tags')}</p>
				) : (
					<ul class="grid gap-4 sm:grid-cols-2">
						{tags.map((tag) => {
							const countLabel = t('blog.tag-count').replace('{count}', String(tag.count));
							return (
								<li class="flex items-center justify-between rounded-xl border border-slate-800 bg-slate-900/40 px-4 py-3 transition hover:border-orange-500/80 hover:bg-orange-500/10">
									<span class="font-semibold text-slate-100">{tag.name}</span>
									<span class="text-sm text-slate-400">{countLabel}</span>
								</li>
							);
						})}
					</ul>
				)}
			</section>
		</main>
		<Footer />
	</body>
</html>
