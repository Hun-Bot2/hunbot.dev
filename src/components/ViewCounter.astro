---
import type { UILanguage } from '../i18n/ui';
import { useTranslations } from '../i18n/ui';

type Props = {
	lang?: UILanguage;
	counterKey?: string;
};

const { lang = 'ko', counterKey } = Astro.props as Props;
const t = useTranslations(lang);

const baseKey = counterKey ?? Astro.url?.pathname ?? 'home';
const trimmedKey = baseKey.replace(/^\/+/, '').replace(/\/+$/, '');
const sanitizedKey = (trimmedKey || 'home').replace(/[^a-zA-Z0-9_-]/g, '-').toLowerCase();
const elementId = `view-counter-${sanitizedKey}`;
const namespace = 'hun-bot.dev-blog';
---

<div
	id={elementId}
	class="view-counter"
	data-view-key={sanitizedKey}
	data-error-text={t('blog.views-error')}
	aria-live="polite"
>
	<div class="view-counter__icon" aria-hidden="true">
		<svg width="18" height="18" viewBox="0 0 24 24" fill="none">
			<path
				d="M1.5 12C1.5 12 5.25 5.25 12 5.25C18.75 5.25 22.5 12 22.5 12C22.5 12 18.75 18.75 12 18.75C5.25 18.75 1.5 12 1.5 12Z"
				stroke="currentColor"
				stroke-width="1.5"
				stroke-linecap="round"
				stroke-linejoin="round"
			/>
			<path
				d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z"
				stroke="currentColor"
				stroke-width="1.5"
				stroke-linecap="round"
				stroke-linejoin="round"
			/>
		</svg>
	</div>
	<div class="view-counter__body">
		<span class="view-counter__label">{t('blog.views')}</span>
		<span class="view-counter__value" data-view-value>{t('blog.views-loading')}</span>
	</div>
</div>

<script is:inline data-target={elementId} data-namespace={namespace}>
{
	const script = document.currentScript;
	if (!script) return;
	const elementId = script.dataset.target;
	const namespace = script.dataset.namespace || 'hun-bot.dev-blog';
	if (!elementId) return;

	const init = () => {
		const container = document.getElementById(elementId);
		if (!container) return;
		const valueEl = container.querySelector('[data-view-value]');
		if (!(valueEl instanceof HTMLElement)) return;
		const key = container.dataset.viewKey || 'home';
		const errorText = container.dataset.errorText || 'n/a';
		const setValue = (value) => {
			valueEl.textContent = new Intl.NumberFormat(undefined).format(value);
			valueEl.dataset.status = 'ready';
		};
		const setError = () => {
			valueEl.textContent = errorText;
			valueEl.dataset.status = 'error';
		};
		const fetchCount = (mode) => {
			const encodedKey = encodeURIComponent(key);
			const url = `https://api.countapi.xyz/${mode}/${namespace}/${encodedKey}`;
			return fetch(url).then((res) => {
				if (!res.ok) throw new Error('Network response was not ok');
				return res.json();
			});
		};
		fetchCount('hit')
			.then((data) => {
				if (typeof data?.value !== 'number') throw new Error('Invalid payload');
				setValue(data.value);
			})
			.catch(() => {
				fetchCount('get')
					.then((data) => {
						if (typeof data?.value !== 'number') throw new Error('Invalid payload');
						setValue(data.value);
					})
					.catch(setError);
			});
	};
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', init, { once: true });
	} else {
		init();
	}
}
</script>

<style>
	.view-counter {
		display: inline-flex;
		align-items: center;
		gap: 0.35rem;
		padding: 0.25rem 0.6rem;
		border-radius: 999px;
		border: 1px solid rgba(248, 249, 250, 0.12);
		background: rgba(15, 23, 42, 0.25);
		color: rgba(248, 249, 250, 0.85);
		font-size: 0.75rem;
		line-height: 1rem;
	}

	:global(body.light-theme) .view-counter {
		background: rgba(248, 249, 250, 0.6);
		color: #0f172a;
		border-color: rgba(15, 23, 42, 0.08);
	}

	.view-counter__icon {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		color: rgba(249, 115, 22, 0.9);
	}

	:global(body.light-theme) .view-counter__icon {
		color: rgba(249, 115, 22, 0.8);
	}

	.view-counter__body {
		display: inline-flex;
		align-items: baseline;
		gap: 0.35rem;
	}

	.view-counter__label {
		font-size: 0.65rem;
		text-transform: uppercase;
		letter-spacing: 0.08em;
		color: rgba(248, 249, 250, 0.65);
	}

	:global(body.light-theme) .view-counter__label {
		color: rgba(15, 23, 42, 0.55);
	}

	.view-counter__value {
		font-weight: 600;
		color: rgba(248, 249, 250, 0.95);
		font-size: 0.8rem;
	}

	:global(body.light-theme) .view-counter__value {
		color: #0f172a;
	}
</style>
