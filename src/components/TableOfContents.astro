---
// TableOfContents ì»´í¬ë„ŒíŠ¸
---

<div id="table-of-contents" class="fixed top-24 right-5 w-72 bg-white/95 dark:bg-slate-800/95 backdrop-blur-lg border border-slate-200 dark:border-slate-600 rounded-xl p-6 shadow-lg shadow-slate-900/10 dark:shadow-slate-900/30 max-h-[calc(100vh-12rem)] overflow-y-auto z-30 transition-all duration-300 opacity-0 translate-x-full lg:opacity-100 lg:translate-x-0 select-none">
	<div id="toc-header" class="flex items-center justify-between mb-4 pb-3 border-b border-slate-200 dark:border-slate-600 cursor-move">
		<h3 class="text-lg font-semibold text-slate-800 dark:text-slate-100 m-0 flex items-center gap-2">
			<svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
			</svg>
			ëª©ì°¨
		</h3>
		<button id="toc-toggle" class="p-1 text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700 rounded transition-all duration-200" aria-label="ëª©ì°¨ í† ê¸€">
			<svg class="w-4 h-4 transition-transform duration-200" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<polyline points="6,9 12,15 18,9"></polyline>
			</svg>
		</button>
	</div>
	<nav id="toc-nav" class="transition-all duration-300 overflow-hidden">
		<ul id="toc-list" class="list-none p-0 m-0 space-y-2">
			<!-- ëª©ì°¨ í•­ëª©ë“¤ì´ JavaScriptë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->
		</ul>
	</nav>
</div>

<style>
	/* ë“œë˜ê·¸ ìƒíƒœ ìŠ¤íƒ€ì¼ */
	.dragging {
		@apply cursor-grabbing shadow-2xl shadow-purple-500/40 scale-105;
		transition: none !important;
		z-index: 9999 !important;
	}
	
	.drag-handle:hover {
		@apply bg-slate-100 dark:bg-slate-700;
	}
	
	/* í† ê¸€ ìƒíƒœ ìŠ¤íƒ€ì¼ */
	.collapsed svg {
		transform: rotate(-90deg);
	}
	
	.collapsed nav {
		max-height: 0;
		opacity: 0;
	}
	
	/* í™œì„± ë§í¬ ìŠ¤íƒ€ì¼ */
	.toc-link {
		@apply block text-slate-600 dark:text-slate-400 no-underline px-3 py-1.5 rounded-md text-sm leading-5 transition-all duration-200 border-l-2 border-transparent;
	}
	
	.toc-link:hover {
		@apply bg-slate-50 dark:bg-slate-700 text-slate-700 dark:text-slate-300 border-l-purple-500;
	}
	
	.toc-link.active {
		@apply bg-gradient-to-r from-purple-500 to-pink-500 text-white font-medium border-l-purple-500 shadow-lg shadow-purple-500/30;
	}
	
	/* í—¤ë”© ë ˆë²¨ë³„ ë“¤ì—¬ì“°ê¸° */
	.toc-h2 { @apply pl-3; }
	.toc-h3 { @apply pl-6; }
	.toc-h4 { @apply pl-9; }
	.toc-h5 { @apply pl-12; }
	/* .toc-h6 { @apply pl-13; } */
	
	/* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
	@media (max-width: 1023px) {
		#table-of-contents {
			@apply translate-x-full opacity-0;
		}
		
		#table-of-contents.mobile-visible {
			@apply translate-x-0 opacity-100;
		}
	}
	
	@media (max-width: 768px) {
		#table-of-contents {
			@apply w-[calc(100vw-2.5rem)] right-5 left-5 max-h-[60vh];
		}
	}
</style>

<script>
	document.addEventListener('DOMContentLoaded', function() {
		const tocContainer = document.getElementById('table-of-contents');
		const tocList = document.getElementById('toc-list');
		const tocToggle = document.getElementById('toc-toggle');
		const tocNav = document.getElementById('toc-nav');
		const tocHeader = document.getElementById('toc-header');
		
		if (!tocContainer || !tocList || !tocHeader) return;
		
		// í—¤ë”© ìš”ì†Œë“¤ ìˆ˜ì§‘
		const headings = document.querySelectorAll('.prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6');
		
		if (headings.length === 0) {
			tocContainer.style.display = 'none';
			return;
		}
		
		// ëª©ì°¨ ìƒì„±
		headings.forEach((heading, index) => {
			const headingElement = heading as HTMLElement;
			// IDê°€ ì—†ìœ¼ë©´ ìƒì„±
			if (!headingElement.id) {
				headingElement.id = `heading-${index}`;
			}
			
			const li = document.createElement('li');
			const a = document.createElement('a');
			
			a.href = `#${headingElement.id}`;
			a.textContent = headingElement.textContent || '';
			a.className = `toc-link toc-${headingElement.tagName.toLowerCase()}`;
			
			li.appendChild(a);
			if (tocList) {
				tocList.appendChild(li);
			}
		});
		
		// í† ê¸€ ê¸°ëŠ¥
		if (tocToggle) {
			tocToggle.addEventListener('click', function() {
				tocContainer.classList.toggle('collapsed');
			});
		}
		
		// ë“œë˜ê·¸ ê¸°ëŠ¥ êµ¬í˜„
		let isDragging = false;
		let dragOffset = { x: 0, y: 0 };
		let currentPosition = { x: 0, y: 0 };
		
		// ë§ˆìš°ìŠ¤ ë‹¤ìš´ ì´ë²¤íŠ¸ (ë“œë˜ê·¸ ì‹œì‘)
		tocHeader.addEventListener('mousedown', function(e) {
			// í† ê¸€ ë²„íŠ¼ í´ë¦­ì€ ë“œë˜ê·¸í•˜ì§€ ì•ŠìŒ
			if (tocToggle && (e.target === tocToggle || tocToggle.contains(e.target as Node))) {
				return;
			}
			
			isDragging = true;
			tocContainer.classList.add('dragging');
			
			const rect = tocContainer.getBoundingClientRect();
			dragOffset.x = e.clientX - rect.left;
			dragOffset.y = e.clientY - rect.top;
			
			// í˜„ì¬ ìœ„ì¹˜ ì €ì¥
			currentPosition.x = rect.left;
			currentPosition.y = rect.top;
			
			// ë§ˆìš°ìŠ¤ ì»¤ì„œ ë³€ê²½
			document.body.style.cursor = 'grabbing';
			
			e.preventDefault();
		});
		
		// ë§ˆìš°ìŠ¤ ì´ë™ ì´ë²¤íŠ¸ (ë“œë˜ê·¸ ì¤‘)
		document.addEventListener('mousemove', function(e) {
			if (!isDragging) return;
			
			const newX = e.clientX - dragOffset.x;
			const newY = e.clientY - dragOffset.y;
			
			// í™”ë©´ ê²½ê³„ ì²´í¬
			const maxX = window.innerWidth - tocContainer.offsetWidth;
			const maxY = window.innerHeight - tocContainer.offsetHeight;
			
			currentPosition.x = Math.max(0, Math.min(newX, maxX));
			currentPosition.y = Math.max(0, Math.min(newY, maxY));
			
			// ìœ„ì¹˜ ì—…ë°ì´íŠ¸
			tocContainer.style.left = currentPosition.x + 'px';
			tocContainer.style.top = currentPosition.y + 'px';
			tocContainer.style.right = 'auto';
			tocContainer.style.transform = 'none';
			
			e.preventDefault();
		});
		
		// ë§ˆìš°ìŠ¤ ì—… ì´ë²¤íŠ¸ (ë“œë˜ê·¸ ì¢…ë£Œ)
		document.addEventListener('mouseup', function() {
			if (!isDragging) return;
			
			isDragging = false;
			tocContainer.classList.remove('dragging');
			document.body.style.cursor = '';
			
			// ìœ„ì¹˜ë¥¼ localStorageì— ì €ì¥
			localStorage.setItem('toc-position', JSON.stringify(currentPosition));
		});
		
		// ì €ì¥ëœ ìœ„ì¹˜ ë³µì›
		function restorePosition() {
			if (!tocContainer) return;
			
			const savedPosition = localStorage.getItem('toc-position');
			if (savedPosition) {
				try {
					const position = JSON.parse(savedPosition);
					
					// í™”ë©´ í¬ê¸°ê°€ ë³€ê²½ë˜ì—ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê²½ê³„ ì²´í¬
					const maxX = window.innerWidth - tocContainer.offsetWidth;
					const maxY = window.innerHeight - tocContainer.offsetHeight;
					
					currentPosition.x = Math.max(0, Math.min(position.x, maxX));
					currentPosition.y = Math.max(0, Math.min(position.y, maxY));
					
					tocContainer.style.left = currentPosition.x + 'px';
					tocContainer.style.top = currentPosition.y + 'px';
					tocContainer.style.right = 'auto';
					tocContainer.style.transform = 'none';
				} catch (e) {
					console.warn('Failed to restore TOC position:', e);
				}
			}
		}
		
		// ìœ„ì¹˜ ì´ˆê¸°í™” í•¨ìˆ˜
		function resetPosition() {
			if (!tocContainer) return;
			
			tocContainer.style.left = '';
			tocContainer.style.top = '';
			tocContainer.style.right = '';
			tocContainer.style.transform = '';
			localStorage.removeItem('toc-position');
		}
		
		// ë”ë¸”í´ë¦­ìœ¼ë¡œ ìœ„ì¹˜ ì´ˆê¸°í™”
		tocHeader.addEventListener('dblclick', function() {
			resetPosition();
		});
		
		// í˜„ì¬ ìœ„ì¹˜ í•˜ì´ë¼ì´íŠ¸
		const tocLinks = tocList.querySelectorAll('a');
		
		function updateActiveLink() {
			let currentHeading: Element | null = null;
			const scrollTop = window.pageYOffset;
			
			headings.forEach(heading => {
				const rect = heading.getBoundingClientRect();
				if (rect.top <= 100) {
					currentHeading = heading;
				}
			});
			
			tocLinks.forEach(link => link.classList.remove('active'));
			
			if (currentHeading && (currentHeading as HTMLElement).id) {
				const activeLink = tocList?.querySelector(`a[href="#${(currentHeading as HTMLElement).id}"]`);
				if (activeLink) {
					activeLink.classList.add('active');
				}
			}
		}
		
		// ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
		let ticking = false;
		window.addEventListener('scroll', function() {
			if (!ticking) {
				requestAnimationFrame(function() {
					updateActiveLink();
					ticking = false;
				});
				ticking = true;
			}
		});
		
		// ì´ˆê¸° í™œì„± ë§í¬ ì„¤ì •
		updateActiveLink();
		
		// ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤
		tocLinks.forEach(link => {
			link.addEventListener('click', function(e) {
				e.preventDefault();
				const href = this.getAttribute('href');
				if (href) {
					const targetId = href.slice(1);
					const targetElement = document.getElementById(targetId);
					
					if (targetElement) {
						const offsetTop = targetElement.offsetTop - 100;
						window.scrollTo({
							top: offsetTop,
							behavior: 'smooth'
						});
					}
				}
			});
		});
		
		// í™”ë©´ í¬ê¸°ì— ë”°ë¥¸ TOC í‘œì‹œ ì œì–´
		function handleTocVisibility() {
			if (!tocContainer) return;
			
			const isDesktop = window.innerWidth > 1024;
			
			if (isDesktop) {
				// ë°ìŠ¤í¬í†±: ìë™ìœ¼ë¡œ í‘œì‹œ
				tocContainer.classList.remove('mobile-visible');
				
				// ê¸°ì¡´ ëª¨ë°”ì¼ í† ê¸€ ë²„íŠ¼ ì œê±°
				const existingBtn = document.querySelector('.mobile-toc-toggle');
				if (existingBtn) {
					existingBtn.remove();
				}
			} else {
				// ëª¨ë°”ì¼/íƒœë¸”ë¦¿: í† ê¸€ ë²„íŠ¼ìœ¼ë¡œ ì œì–´
				// ëª¨ë°”ì¼ í† ê¸€ ë²„íŠ¼ì´ ì—†ìœ¼ë©´ ìƒì„±
				if (!document.querySelector('.mobile-toc-toggle')) {
					const tocToggleBtn = document.createElement('button');
					tocToggleBtn.innerHTML = 'ğŸ“‹ ëª©ì°¨';
					tocToggleBtn.className = 'mobile-toc-toggle fixed top-20 right-5 z-50 bg-gradient-to-r from-purple-500 to-pink-500 text-white border-0 px-4 py-2 rounded-lg text-sm font-medium cursor-pointer shadow-lg shadow-purple-500/30 transition-all duration-200 hover:shadow-xl hover:scale-105';
					
					tocToggleBtn.addEventListener('click', function() {
						if (tocContainer) {
							tocContainer.classList.toggle('mobile-visible');
						}
					});
					
					document.body.appendChild(tocToggleBtn);
					
					// ì™¸ë¶€ í´ë¦­ ì‹œ TOC ë‹«ê¸°
					document.addEventListener('click', function(e) {
						const target = e.target as Node;
						if (tocContainer && !tocContainer.contains(target) && !tocToggleBtn.contains(target)) {
							tocContainer.classList.remove('mobile-visible');
						}
					});
				}
			}
		}
		
		// ì´ˆê¸° ì‹¤í–‰
		handleTocVisibility();
		
		// ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
		window.addEventListener('resize', handleTocVisibility);
	});
</script> 