---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import FloatingLanguagePicker from '../components/FloatingLanguagePicker.astro';
import FormattedDate from '../components/FormattedDate.astro';
import TableOfContents from '../components/TableOfContents.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import GiscusComments from '../components/GiscusComments.astro';
import ViewCounter from '../components/ViewCounter.astro';
import { SITE_TITLE, AUTHOR, AUTHOR_EMAIL, SOCIAL_LINKS } from '../consts';
import type { UILanguage } from '../i18n/ui';

type Props = CollectionEntry<'blog'>['data'] & {
	lang?: UILanguage;
	availableLangs?: string[];
	postId?: string;
};

const {
	title,
	description,
	pubDate,
	updatedDate,
	heroImage,
	tags = [],
	lang = 'ko',
	availableLangs,
	postId,
} = Astro.props as Props;

const slug = postId ?? Astro.url.pathname;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const headingId = 'post-title';
const proseClass = `prose prose-slate max-w-none text-slate-200 leading-relaxed text-base
	[&>h1]:text-2xl sm:[&>h1]:text-3xl [&>h1]:font-bold [&>h1]:mt-0 [&>h1]:mb-4 [&>h1]:text-slate-900 [&>h1]:dark:text-white [&>h1]:leading-tight [&>h1]:tracking-tight
	[&>h2]:text-xl sm:[&>h2]:text-2xl [&>h2]:font-semibold [&>h2]:mt-8 [&>h2]:mb-4 [&>h2]:text-slate-800 [&>h2]:dark:text-slate-50 [&>h2]:leading-tight
	[&>h3]:text-lg sm:[&>h3]:text-xl [&>h3]:font-semibold [&>h3]:mt-6 [&>h3]:mb-3 [&>h3]:text-slate-800 [&>h3]:dark:text-slate-50 [&>h3]:leading-tight
	[&>h4]:text-base sm:[&>h4]:text-lg [&>h4]:font-semibold [&>h4]:mt-5 [&>h4]:mb-2 [&>h4]:text-slate-800 [&>h4]:dark:text-slate-50
	[&>h5]:text-base sm:[&>h5]:text-lg [&>h5]:font-semibold [&>h5]:mt-5 [&>h5]:mb-2 [&>h5]:text-slate-800 [&>h5]:dark:text-slate-50
	[&>h6]:text-base sm:[&>h6]:text-lg [&>h6]:font-semibold [&>h6]:mt-5 [&>h6]:mb-2 [&>h6]:text-slate-800 [&>h6]:dark:text-slate-50
	[&>p]:mb-5 [&>p]:text-base [&>p]:leading-relaxed
	[&>ul]:mb-5 [&>ul]:pl-6 [&>ul]:list-disc [&>ol]:mb-5 [&>ol]:pl-6 [&>ol]:list-decimal
	[&>ul>li]:mb-2 [&>ol>li]:mb-2 [&>li]:leading-relaxed
	[&_ul]:list-disc [&_ul]:pl-6 [&_ul]:mt-1 [&_ul]:mb-2
	[&_ol]:list-decimal [&_ol]:pl-6 [&_ol]:mt-1 [&_ol]:mb-2
	[&_ul>li]:mb-1 [&_ol>li]:mb-1
	[&_li>ul]:mt-1 [&_li>ol]:mt-1
	[&>a]:text-slate-900 dark:[&>a]:text-slate-100 [&>a]:no-underline [&>a]:transition-colors [&>a]:hover:text-orange-600 dark:[&>a]:hover:text-orange-400
	[&>blockquote]:border-l-4 [&>blockquote]:border-orange-500 [&>blockquote]:my-6 [&>blockquote]:pl-4 [&>blockquote]:italic [&>blockquote]:text-slate-300 [&>blockquote]:dark:text-slate-300
	[&>table]:w-full [&>table]:border-collapse [&>table]:my-6 [&>table]:text-sm [&>table]:overflow-x-auto [&>table]:block sm:[&>table]:table
	[&>th]:border [&>th]:border-slate-200 [&>th]:dark:border-slate-700 [&>th]:p-3 [&>th]:text-left [&>th]:bg-slate-50 [&>th]:dark:bg-slate-900 [&>th]:font-semibold
	[&>td]:border [&>td]:border-slate-200 [&>td]:dark:border-slate-700 [&>td]:p-3 [&>td]:text-left
	[&>img]:rounded-lg [&>img]:shadow-sm [&>img]:my-6 [&>img]:max-w-full [&>img]:h-auto
	[&_.katex-display]:text-center [&_.katex-display]:text-1.5xl sm:[&_.katex-display]:text-2xl [&_.katex-display]:my-6`;
const heroImageSizes = '(min-width: 768px) 768px, 100vw';

const schema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": canonicalURL.href
  },
  "headline": title,
  "description": description,
	"image": heroImage ? new URL(heroImage, Astro.site).href : new URL('/placeholder-social.jpg', Astro.site).href,
  "datePublished": pubDate.toISOString(),
  "dateModified": updatedDate ? updatedDate.toISOString() : pubDate.toISOString(),
  "author": {
    "@type": "Person",
    "name": AUTHOR,
    "url": new URL(Astro.url.origin).href,
    "email": AUTHOR_EMAIL,
    "sameAs": [
      SOCIAL_LINKS.github,
      SOCIAL_LINKS.linkedin
    ]
  },
  "publisher": {
    "@type": "Organization",
    "name": SITE_TITLE,
    "logo": {
      "@type": "ImageObject",
      "url": new URL('/favicon.svg', Astro.site).href
    }
  }
};
---

<html lang={lang}>
	<head>
		<BaseHead title={title} description={description} canonicalURL={canonicalURL.href} image={heroImage} />
		<script type="application/ld+json" set:html={JSON.stringify(schema)} />
		<!-- Essential SEO meta tags -->
		<meta property="og:type" content="article" />
		<meta property="article:author" content="Hun-Bot" />
		<meta property="article:published_time" content={pubDate.toISOString()} />
		{updatedDate && <meta property="article:modified_time" content={updatedDate.toISOString()} />}
		{tags.map(tag => <meta property="article:tag" content={tag} />)}
	</head>

	<body>
		<Header />
		<FloatingLanguagePicker availableLangs={availableLangs} />
		<main class="max-w-4xl mx-auto px-6 py-8">
			<article aria-labelledby={headingId}>
				<!-- Hero Image -->
				{heroImage && (
					<figure class="mb-8">
						<img 
							src={heroImage}
							alt={title}
							loading="lazy"
							decoding="async"
							sizes={heroImageSizes}
							class="w-full max-h-[70vh] rounded-lg shadow-sm object-contain"
						/>
						{(description || title) && <figcaption class="sr-only">{description || title}</figcaption>}
					</figure>
				)}
				
				<!-- Breadcrumb Navigation -->
				<Breadcrumb items={[
					{ name: "Home", href: "/" },
					{ name: "Blog", href: "/blog" },
					{ name: title }
				]} />
				
				<!-- Title Section -->
				<div class="mb-8 pb-6 border-b border-slate-200 dark:border-slate-700">
					<!-- Meta -->
					<div class="mb-4 flex flex-wrap items-center gap-3 text-slate-600 dark:text-slate-400 text-sm">
						<div>
							<FormattedDate date={pubDate} />
							{updatedDate && (
								<div class="text-slate-500 dark:text-slate-400 text-xs mt-1">
									Last updated: <FormattedDate date={updatedDate} />
								</div>
							)}
						</div>
						<div class="flex items-center before:content-['â€¢'] before:mr-3 before:text-slate-300 dark:before:text-slate-600">
							<ViewCounter slug={slug} />
						</div>
					</div>
					
					<!-- Title -->
					<h1 id={headingId} class="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-slate-100 leading-tight tracking-tight mb-4">
						{title}
					</h1>
					
					<!-- Tags -->
					{tags && tags.length > 0 && (
  						<div class="flex flex-wrap gap-2 mt-4">
    						{tags.map((tag: string) => 
								(<span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium	border text-slate-700 dark:text-slate-200 border-slate-300 dark:border-slate-600 bg-slate-100 dark:bg-transparent">
									{tag}
								</span>
							))}
						</div>
						)}
				</div>
				
				<!-- Main Content -->
				<div class={proseClass}>
					<slot />
				</div>
				
				<TableOfContents lang={lang} />
				<GiscusComments lang={lang} />
			</article>
		</main>
		<Footer />
	</body>
</html>
